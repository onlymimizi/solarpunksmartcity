<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3Dè™šæ‹ŸåŸå¸‚ - Solarpunk Smart City</title>
    <link rel="stylesheet" href="../components/ui.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <!-- é«˜ç§‘æŠ€èƒŒæ™¯ -->
    <div class="tech-background">
        <div class="grid-overlay"></div>
        <div class="floating-particles"></div>
        <div class="scan-lines"></div>
    </div>
    
    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 0 40px;">
        <div class="back-button-container">
            <a href="./index.html" class="back-button">â† è¿”å›ä¸»é¡µ</a>
        </div>
        
        <!-- é¡µé¢æ ‡é¢˜åŒºåŸŸ -->
        <div class="page-header" style="text-align: center; margin-bottom: 60px;">
            <div class="tech-badge">
                <div class="badge-glow"></div>
                <span class="badge-text">ğŸ™ï¸ 3D CITY VISUALIZATION MODULE</span>
            </div>
            <h1 style="margin: 30px 0 20px;">3Dè™šæ‹ŸåŸå¸‚</h1>
            <p style="font-size: 1.3rem; color: rgba(255, 255, 255, 0.8); max-width: 800px; margin: 0 auto;">
                æ²‰æµ¸å¼å¤ªé˜³èƒ½æœ‹å…‹åŸå¸‚ä¸‰ç»´å»ºæ¨¡ä¸å®æ—¶æ¸²æŸ“ç³»ç»Ÿ
            </p>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ - å·¦å³å¸ƒå±€ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px;">
        
        <!-- å·¦ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
        <div class="tech-module city-module">
            <div class="module-header">
                <div class="module-icon">ğŸ—ï¸</div>
                <div class="module-title">åŸå¸‚å‚æ•°æ§åˆ¶</div>
                <div class="module-subtitle">City Generation Parameters</div>
            </div>
            
            <div class="module-content">
                <!-- åŸå¸‚ç”Ÿæˆå‚æ•° -->
                <div class="input-group">
                    <label for="seed">éšæœºç§å­ (Random Seed)</label>
                    <input type="number" id="seed" value="42" min="1" max="1000" class="tech-input">
                </div>
                
                <div class="input-group">
                    <label for="grid">ç½‘æ ¼å¤§å° (Grid Size)</label>
                    <input type="number" id="grid" value="6" min="3" max="12" class="tech-input">
                </div>
                
                <div class="input-group">
                    <label for="maxH">æœ€å¤§é«˜åº¦ (Max Height)</label>
                    <input type="number" id="maxH" value="16" min="5" max="30" class="tech-input">
                </div>
                
                <button onclick="generateCity()" class="tech-button city-button">
                    <span class="button-text">ğŸš€ ç”ŸæˆåŸå¸‚</span>
                </button>
                
                <!-- ç›¸æœºæ§åˆ¶ -->
                <div style="margin-top: 30px;">
                    <h3 style="color: #4caf50; margin-bottom: 15px;">ğŸ“· ç›¸æœºæ§åˆ¶</h3>
                    <button onclick="toggleAutoRotate()" class="tech-button city-button" style="margin-bottom: 10px;">
                        <span class="button-text" id="rotateText">ğŸ”„ å¼€å¯è‡ªåŠ¨æ—‹è½¬</span>
                    </button>
                    <button onclick="resetCamera()" class="tech-button city-button">
                        <span class="button-text">ğŸ¯ é‡ç½®è§†è§’</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼š3Dè§†çª— -->
        <div class="tech-module city-module">
            <div class="module-header">
                <div class="module-icon">ğŸŒ†</div>
                <div class="module-title">3DåŸå¸‚è§†çª—</div>
                <div class="module-subtitle">Real-time 3D City Rendering</div>
            </div>
            
            <div class="module-content" style="padding: 0; height: 500px; position: relative;">
                <!-- 3Dè§†çª—å®¹å™¨ -->
                <div id="viewport" style="width: 100%; height: 100%; background: #000; border-radius: 15px; overflow: hidden; position: relative;">
                    <div id="loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #4caf50; font-size: 1.2rem; z-index: 1000; text-align: center;">
                        <div style="width: 40px; height: 40px; border: 4px solid rgba(76, 175, 80, 0.3); border-top: 4px solid #4caf50; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                        <p style="font-size: 1.1rem; font-weight: 700; margin-bottom: 10px;">ğŸŒ± æ­£åœ¨åˆå§‹åŒ–3Då¼•æ“</p>
                        <p style="font-size: 0.9rem; color: #81c784;">WebGLæ¸²æŸ“å™¨å¯åŠ¨ä¸­...</p>
                    </div>
                    <canvas id="cityCanvas" style="width: 100%; height: 100%; display: block;"></canvas>
                </div>
            </div>
        </div>
        </div>
        
        <!-- æ€§èƒ½ç›‘æ§é¢æ¿ -->
        <div class="tech-module city-module" style="margin-bottom: 40px;">
            <div class="module-header">
                <div class="module-icon">ğŸ“Š</div>
                <div class="module-title">å®æ—¶æ€§èƒ½ç›‘æ§</div>
                <div class="module-subtitle">Real-time Performance Statistics</div>
            </div>
            
            <div class="module-content">
                <div class="tech-specs">
                    <div class="spec-item">
                        <span class="spec-label">FPS</span>
                        <span class="spec-value" id="fps-counter">--</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-label">å»ºç­‘æ•°é‡</span>
                        <span class="spec-value" id="building-count">--</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-label">ä¸‰è§’å½¢</span>
                        <span class="spec-value" id="triangle-count">--</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-label">çŠ¶æ€</span>
                        <span class="spec-value" id="render-status">åˆå§‹åŒ–ä¸­</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ§åˆ¶è¯´æ˜ -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 40px;">
            <div class="tech-module city-module">
                <div class="module-header">
                    <div class="module-icon">ğŸ–±ï¸</div>
                    <div class="module-title">äº¤äº’æ§åˆ¶</div>
                    <div class="module-subtitle">Interactive Controls</div>
                </div>
                <div class="module-content">
                    <div style="line-height: 1.8; color: #81c784;">
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #4caf50;">
                            â€¢ é¼ æ ‡æ‹–æ‹½ï¼š360Â°æ—‹è½¬è§†è§’
                        </div>
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #4caf50;">
                            â€¢ æ»šè½®ç¼©æ”¾ï¼šè¿œè¿‘è§†å›¾åˆ‡æ¢
                        </div>
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 12px 16px; border-radius: 8px; border-left: 3px solid #4caf50;">
                            â€¢ è‡ªåŠ¨æ—‹è½¬ï¼šæ²‰æµ¸å¼ä½“éªŒ
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tech-module city-module">
                <div class="module-header">
                    <div class="module-icon">ğŸŒ±</div>
                    <div class="module-title">å¯æŒç»­å…ƒç´ </div>
                    <div class="module-subtitle">Sustainable Features</div>
                </div>
                <div class="module-content">
                    <div style="line-height: 1.8; color: #81c784;">
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #4caf50;">
                            â€¢ ç»¿è‰²å±‹é¡¶èŠ±å›­ç³»ç»Ÿ
                        </div>
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #4caf50;">
                            â€¢ å¤ªé˜³èƒ½ç”µæ± æ¿é˜µåˆ—
                        </div>
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #4caf50;">
                            â€¢ å¾®å‹é£åŠ›å‘ç”µæœº
                        </div>
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 12px 16px; border-radius: 8px; border-left: 3px solid #4caf50;">
                            â€¢ å‚ç›´ç»¿åŒ–ç«‹ä½“ç³»ç»Ÿ
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let scene, camera, renderer, controls;
        let cityData = { buildings: [], stats: { fps: 0, buildings: 0, triangles: 0 } };
        let autoRotate = false;
        let animationId;
        
        // æ£€æŸ¥WebGLæ”¯æŒ
        function checkWebGLSupport() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                return !!gl;
            } catch (e) {
                return false;
            }
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const loading = document.getElementById('loading');
            loading.innerHTML = `
                <div style="color: #f44336; text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 15px;">âŒ</div>
                    <div style="font-size: 1.2rem; margin-bottom: 15px;">${message}</div>
                    <div style="font-size: 0.9rem; color: #ccc; line-height: 1.6;">
                        è¯·å°è¯•ï¼š<br>
                        â€¢ æ›´æ–°æµè§ˆå™¨åˆ°æœ€æ–°ç‰ˆæœ¬<br>
                        â€¢ å¯ç”¨ç¡¬ä»¶åŠ é€Ÿ<br>
                        â€¢ æ£€æŸ¥æ˜¾å¡é©±åŠ¨ç¨‹åº
                    </div>
                </div>
            `;
        }
        
        // åˆå§‹åŒ–3Dåœºæ™¯
        function init3DScene() {
            try {
                // æ£€æŸ¥WebGLæ”¯æŒ
                if (!checkWebGLSupport()) {
                    throw new Error('æµè§ˆå™¨ä¸æ”¯æŒWebGL');
                }
                
                const viewport = document.getElementById('viewport');
                const canvas = document.getElementById('cityCanvas');
                
                // åˆ›å»ºåœºæ™¯
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x0a0a0a);
                scene.fog = new THREE.Fog(0x0a0a0a, 50, 200);
                
                // åˆ›å»ºç›¸æœº
                camera = new THREE.PerspectiveCamera(
                    75, 
                    viewport.clientWidth / viewport.clientHeight, 
                    0.1, 
                    1000
                );
                camera.position.set(30, 25, 30);
                
                // åˆ›å»ºæ¸²æŸ“å™¨
                renderer = new THREE.WebGLRenderer({ 
                    canvas: canvas,
                    antialias: true,
                    alpha: true 
                });
                renderer.setSize(viewport.clientWidth, viewport.clientHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFShadowMap;
                renderer.outputEncoding = THREE.sRGBEncoding;
                
                // åˆ›å»ºæ§åˆ¶å™¨
                controls = new THREE.OrbitControls(camera, canvas);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.maxPolarAngle = Math.PI / 2;
                controls.minDistance = 10;
                controls.maxDistance = 100;
                
                // æ·»åŠ å…‰ç…§
                setupLighting();
                
                // åˆ›å»ºåœ°é¢
                createGround();
                
                // éšè—åŠ è½½æç¤º
                document.getElementById('loading').style.display = 'none';
                
                // ç”Ÿæˆåˆå§‹åŸå¸‚
                generateCity();
                
                // å¼€å§‹æ¸²æŸ“å¾ªç¯
                startRenderLoop();
                
                // å¤„ç†çª—å£å¤§å°å˜åŒ–
                window.addEventListener('resize', onWindowResize);
                
                console.log('âœ… 3Dæ¸²æŸ“å¼•æ“åˆå§‹åŒ–æˆåŠŸ');
                updateStatus('è¿è¡Œä¸­');
                
            } catch (error) {
                console.error('âŒ 3Dæ¸²æŸ“å¼•æ“åˆå§‹åŒ–å¤±è´¥:', error);
                showError('æ¸²æŸ“å¼•æ“åˆå§‹åŒ–å¤±è´¥<br>è¯·æ£€æŸ¥æµè§ˆå™¨WebGLæ”¯æŒ');
                updateStatus('åˆå§‹åŒ–å¤±è´¥');
            }
        }
        
        // è®¾ç½®å…‰ç…§
        function setupLighting() {
            // ç¯å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            // æ–¹å‘å…‰ï¼ˆå¤ªé˜³å…‰ï¼‰
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(50, 50, 25);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 200;
            directionalLight.shadow.camera.left = -50;
            directionalLight.shadow.camera.right = 50;
            directionalLight.shadow.camera.top = 50;
            directionalLight.shadow.camera.bottom = -50;
            scene.add(directionalLight);
            
            // è¡¥å……å…‰æº
            const fillLight = new THREE.DirectionalLight(0x87ceeb, 0.4);
            fillLight.position.set(-25, 20, -25);
            scene.add(fillLight);
        }
        
        // åˆ›å»ºåœ°é¢
        function createGround() {
            const groundGeometry = new THREE.PlaneGeometry(100, 100);
            const groundMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x1a237e,
                transparent: true,
                opacity: 0.8
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
        }
        
        // ç”ŸæˆåŸå¸‚
        function generateCity() {
            try {
                updateStatus('ç”ŸæˆåŸå¸‚ä¸­...');
                
                // æ¸…é™¤ç°æœ‰å»ºç­‘
                clearBuildings();
                
                // è·å–å‚æ•°
                const seed = parseInt(document.getElementById('seed').value) || 42;
                const gridSize = parseInt(document.getElementById('grid').value) || 6;
                const maxHeight = parseInt(document.getElementById('maxH').value) || 16;
                
                // è®¾ç½®éšæœºç§å­
                Math.seedrandom = function(seed) {
                    let m = 0x80000000;
                    let a = 1103515245;
                    let c = 12345;
                    let state = seed ? seed : Math.floor(Math.random() * (m - 1));
                    
                    return function() {
                        state = (a * state + c) % m;
                        return state / (m - 1);
                    };
                };
                
                const random = Math.seedrandom(seed);
                
                // ç”Ÿæˆå»ºç­‘
                const buildings = [];
                const spacing = 8;
                const offset = (gridSize - 1) * spacing / 2;
                
                for (let x = 0; x < gridSize; x++) {
                    for (let z = 0; z < gridSize; z++) {
                        if (random() > 0.3) { // 70%æ¦‚ç‡ç”Ÿæˆå»ºç­‘
                            const building = createBuilding(
                                x * spacing - offset,
                                z * spacing - offset,
                                2 + random() * (maxHeight - 2),
                                random
                            );
                            buildings.push(building);
                            scene.add(building);
                        }
                    }
                }
                
                cityData.buildings = buildings;
                cityData.stats.buildings = buildings.length;
                
                updateStats();
                updateStatus('ç”Ÿæˆå®Œæˆ');
                
                console.log(`ğŸ—ï¸ åŸå¸‚ç”Ÿæˆå®Œæˆ: ${buildings.length} æ ‹å»ºç­‘`);
                
            } catch (error) {
                console.error('âŒ åŸå¸‚ç”Ÿæˆå¤±è´¥:', error);
                updateStatus('ç”Ÿæˆå¤±è´¥');
            }
        }
        
        // åˆ›å»ºå»ºç­‘
        function createBuilding(x, z, height, random) {
            const width = 2 + random() * 2;
            const depth = 2 + random() * 2;
            
            const geometry = new THREE.BoxGeometry(width, height, depth);
            
            // éšæœºæè´¨
            let material;
            const materialType = random();
            
            if (materialType < 0.3) {
                // ç»ç’ƒå»ºç­‘
                material = new THREE.MeshPhysicalMaterial({
                    color: 0x88ccff,
                    transparent: true,
                    opacity: 0.7,
                    roughness: 0.1,
                    metalness: 0.1
                });
            } else if (materialType < 0.6) {
                // æ··å‡åœŸå»ºç­‘
                material = new THREE.MeshLambertMaterial({
                    color: new THREE.Color().setHSL(0.6, 0.3, 0.4 + random() * 0.3)
                });
            } else {
                // å‘å…‰å»ºç­‘
                material = new THREE.MeshStandardMaterial({
                    color: 0x4caf50,
                    emissive: 0x002200,
                    emissiveIntensity: 0.2
                });
            }
            
            const building = new THREE.Mesh(geometry, material);
            building.position.set(x, height / 2, z);
            building.castShadow = true;
            building.receiveShadow = true;
            
            return building;
        }
        
        // æ¸…é™¤å»ºç­‘
        function clearBuildings() {
            cityData.buildings.forEach(building => {
                scene.remove(building);
                building.geometry.dispose();
                building.material.dispose();
            });
            cityData.buildings = [];
        }
        
        // å¼€å§‹æ¸²æŸ“å¾ªç¯
        function startRenderLoop() {
            let lastTime = performance.now();
            let frameCount = 0;
            
            function animate() {
                animationId = requestAnimationFrame(animate);
                
                const currentTime = performance.now();
                frameCount++;
                
                // æ¯ç§’æ›´æ–°ä¸€æ¬¡FPS
                if (currentTime - lastTime >= 1000) {
                    cityData.stats.fps = Math.round(frameCount * 1000 / (currentTime - lastTime));
                    frameCount = 0;
                    lastTime = currentTime;
                    updateStats();
                }
                
                controls.update();
                
                if (autoRotate) {
                    controls.autoRotate = true;
                    controls.autoRotateSpeed = 2.0;
                } else {
                    controls.autoRotate = false;
                }
                
                renderer.render(scene, camera);
            }
            
            animate();
        }
        
        // çª—å£å¤§å°å˜åŒ–å¤„ç†
        function onWindowResize() {
            const viewport = document.getElementById('viewport');
            camera.aspect = viewport.clientWidth / viewport.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(viewport.clientWidth, viewport.clientHeight);
        }
        
        // åˆ‡æ¢è‡ªåŠ¨æ—‹è½¬
        function toggleAutoRotate() {
            autoRotate = !autoRotate;
            const rotateText = document.getElementById('rotateText');
            rotateText.textContent = autoRotate ? 'â¸ï¸ åœæ­¢æ—‹è½¬' : 'ğŸ”„ å¼€å¯è‡ªåŠ¨æ—‹è½¬';
        }
        
        // é‡ç½®ç›¸æœº
        function resetCamera() {
            camera.position.set(30, 25, 30);
            controls.target.set(0, 0, 0);
            controls.update();
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('fps-counter').textContent = cityData.stats.fps;
            document.getElementById('building-count').textContent = cityData.stats.buildings;
            
            // è®¡ç®—ä¸‰è§’å½¢æ•°é‡
            let triangles = 0;
            cityData.buildings.forEach(building => {
                if (building.geometry) {
                    triangles += building.geometry.attributes.position.count / 3;
                }
            });
            cityData.stats.triangles = Math.round(triangles);
            document.getElementById('triangle-count').textContent = cityData.stats.triangles;
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(status) {
            document.getElementById('render-status').textContent = status;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(init3DScene, 100); // å»¶è¿Ÿ100msç¡®ä¿DOMå®Œå…¨åŠ è½½
        });
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            clearBuildings();
        });
    </script>
</body>
</html>