<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>区块链治理 - Solarpunk Smart City</title>
    <link rel="stylesheet" href="../components/ui.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
    <!-- 高科技背景 -->
    <div class="tech-background">
        <div class="grid-overlay"></div>
        <div class="floating-particles"></div>
        <div class="scan-lines"></div>
    </div>
    
    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 0 40px;">
        <div class="back-button-container">
            <a href="./index.html" class="back-button">← 返回主页</a>
        </div>
        
        <!-- 页面标题区域 -->
        <div class="page-header" style="text-align: center; margin-bottom: 60px;">
            <div class="tech-badge">
                <div class="badge-glow"></div>
                <span class="badge-text">🔗 BLOCKCHAIN GOVERNANCE MODULE</span>
            </div>
            <h1 style="margin: 30px 0 20px;">区块链治理</h1>
            <p style="font-size: 1.3rem; color: rgba(255, 255, 255, 0.8); max-width: 800px; margin: 0 auto;">
                去中心化数据存证与智能合约治理平台
            </p>
        </div>

        <!-- 主要内容区域 - 左右布局 -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px;">
        
        <!-- 左侧：钱包连接 -->
        <div class="tech-module blockchain-module">
            <div class="module-header">
                <div class="module-status-bar">
                    <div class="status-indicator" id="wallet-status"></div>
                    <span class="status-text" id="wallet-status-text">WALLET DISCONNECTED</span>
                </div>
                <div class="module-id">WALLET</div>
            </div>
            
            <div class="module-icon-container">
                <div class="icon-background blockchain-bg"></div>
                <div class="module-icon">👛</div>
                <div class="icon-pulse blockchain-pulse"></div>
            </div>
            
            <div class="module-info">
                <h3 class="module-name">Web3钱包连接</h3>
                <p class="module-description">选择Web3钱包连接区块链网络</p>
            </div>
            
            <!-- 钱包选择网格 -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 30px 0;">
                <button onclick="connectMetaMask()" class="tech-button wallet-button" style="padding: 12px 8px; font-size: 0.9rem;">
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <span style="font-size: 1.8rem; margin-bottom: 5px;">🦊</span>
                        <span class="button-text">MetaMask</span>
                    </div>
                </button>
                
                <button onclick="connectWalletConnect()" class="tech-button wallet-button" style="padding: 12px 8px; font-size: 0.9rem;">
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <span style="font-size: 1.8rem; margin-bottom: 5px;">📱</span>
                        <span class="button-text">WalletConnect</span>
                    </div>
                </button>
                
                <button onclick="connectCoinbase()" class="tech-button wallet-button" style="padding: 12px 8px; font-size: 0.9rem;">
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <span style="font-size: 1.8rem; margin-bottom: 5px;">🔵</span>
                        <span class="button-text">Coinbase</span>
                    </div>
                </button>
                
                <button onclick="connectTrust()" class="tech-button wallet-button" style="padding: 12px 8px; font-size: 0.9rem;">
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <span style="font-size: 1.8rem; margin-bottom: 5px;">🛡️</span>
                        <span class="button-text">Trust</span>
                    </div>
                </button>
                
                <button onclick="connectBinance()" class="tech-button wallet-button" style="padding: 12px 8px; font-size: 0.9rem;">
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <span style="font-size: 1.8rem; margin-bottom: 5px;">🟡</span>
                        <span class="button-text">Binance</span>
                    </div>
                </button>
                
                <button onclick="connectOKX()" class="tech-button wallet-button" style="padding: 12px 8px; font-size: 0.9rem;">
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <span style="font-size: 1.8rem; margin-bottom: 5px;">⚫</span>
                        <span class="button-text">OKX</span>
                    </div>
                </button>
            </div>
            
            <div style="text-align: center; font-size: 0.8rem; color: #666; margin-bottom: 20px;">
                支持主流Web3钱包 | 安全连接 | 一键切换
            </div>
            
            <div id="wallet-info" style="display: none; background: rgba(255, 152, 0, 0.1); border: 2px solid rgba(255, 152, 0, 0.3); border-radius: 15px; padding: 25px; margin-top: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #ff9800; font-size: 0.9rem;">钱包地址</label>
                        <div id="wallet-address" style="font-family: 'Courier New', monospace; font-size: 0.9rem; color: #ffcc02; word-break: break-all; background: rgba(255, 152, 0, 0.1); padding: 10px; border-radius: 8px;">未连接</div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #ff9800; font-size: 0.9rem;">网络</label>
                        <div id="network-info" style="font-size: 1rem; color: #ffcc02; background: rgba(255, 152, 0, 0.1); padding: 10px; border-radius: 8px;">未连接</div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #ff9800; font-size: 0.9rem;">余额</label>
                        <div id="wallet-balance" style="font-size: 1rem; color: #ffcc02; background: rgba(255, 152, 0, 0.1); padding: 10px; border-radius: 8px;">0 ETH</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧：数据存证 -->
        <div class="tech-module blockchain-module">
            <div class="module-header">
                <div class="module-status-bar">
                    <div class="status-indicator active"></div>
                    <span class="status-text">DATA STORAGE READY</span>
                </div>
                <div class="module-id">STORAGE</div>
            </div>
            
            <div class="module-icon-container">
                <div class="icon-background blockchain-bg"></div>
                <div class="module-icon">💾</div>
                <div class="icon-pulse blockchain-pulse"></div>
            </div>
            
            <div class="module-info">
                <h3 class="module-name">数据存证系统</h3>
                <p class="module-description">将重要数据永久存储在区块链上</p>
            </div>
            
            <div style="background: rgba(255, 152, 0, 0.1); border: 2px solid rgba(255, 152, 0, 0.3); border-radius: 15px; padding: 25px; margin: 30px 0;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                    <div>
                        <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #ff9800; font-size: 1rem; letter-spacing: 1px;">
                            📄 数据标题
                        </label>
                        <input id="data-title" type="text" placeholder="输入数据标题" style="width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid rgba(255, 152, 0, 0.4); border-radius: 10px; background: rgba(255, 152, 0, 0.05); color: white;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #ff9800; font-size: 1rem; letter-spacing: 1px;">
                            🏷️ 数据类型
                        </label>
                        <select id="data-type" style="width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid rgba(255, 152, 0, 0.4); border-radius: 10px; background: rgba(255, 152, 0, 0.05); color: white;">
                            <option value="health">健康数据</option>
                            <option value="traffic">交通数据</option>
                            <option value="city">城市数据</option>
                            <option value="other">其他数据</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #ff9800; font-size: 1rem; letter-spacing: 1px;">
                        📝 数据内容
                    </label>
                    <textarea id="data-content" rows="4" placeholder="输入要存证的数据内容..." style="width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid rgba(255, 152, 0, 0.4); border-radius: 10px; background: rgba(255, 152, 0, 0.05); color: white; resize: vertical;"></textarea>
                </div>
                
                <div style="text-align: center; margin-top: 25px;">
                    <button id="store-data-btn" class="tech-button blockchain-button" style="width: auto; padding: 18px 40px; font-size: 1.2rem; min-width: 280px;" disabled>
                        <span class="button-text">🔐 存储到区块链</span>
                        <div class="button-arrow">→</div>
                        <div class="button-glow"></div>
                    </button>
                </div>
            </div>
        </div>
        
        </div> <!-- 结束左右布局容器 -->

        <!-- 区块链统计 -->
        <div class="tech-module blockchain-module">
            <div class="module-header">
                <div class="module-status-bar">
                    <div class="status-indicator active"></div>
                    <span class="status-text">BLOCKCHAIN STATS</span>
                </div>
                <div class="module-id">STATS</div>
            </div>
            
            <div class="module-icon-container">
                <div class="icon-background blockchain-bg"></div>
                <div class="module-icon">📊</div>
                <div class="icon-pulse blockchain-pulse"></div>
            </div>
            
            <div class="module-info">
                <h3 class="module-name">区块链网络统计</h3>
                <p class="module-description">实时区块链网络状态与交易统计</p>
            </div>
            
            <!-- 技术规格 -->
            <div class="tech-specs">
                <div class="spec-item">
                    <span class="spec-label">NETWORK</span>
                    <span class="spec-value">Web3</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">TXN</span>
                    <span class="spec-value" id="total-transactions">47,293</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">SECURITY</span>
                    <span class="spec-value">100%</span>
                </div>
            </div>
            
            <!-- 统计数据 -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
                <div style="background: rgba(255, 152, 0, 0.1); border: 2px solid rgba(255, 152, 0, 0.3); border-radius: 15px; padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">⛓️</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #ff9800; margin-bottom: 5px;" id="block-height">18,547,293</div>
                    <div style="font-size: 0.9rem; color: #ffcc02;">当前区块高度</div>
                </div>
                
                <div style="background: rgba(255, 152, 0, 0.1); border: 2px solid rgba(255, 152, 0, 0.3); border-radius: 15px; padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">⛽</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #ff9800; margin-bottom: 5px;" id="gas-price">25</div>
                    <div style="font-size: 0.9rem; color: #ffcc02;">Gas价格 Gwei</div>
                </div>
                
                <div style="background: rgba(255, 152, 0, 0.1); border: 2px solid rgba(255, 152, 0, 0.3); border-radius: 15px; padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">🔐</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #ff9800; margin-bottom: 5px;" id="stored-records">1,247</div>
                    <div style="font-size: 0.9rem; color: #ffcc02;">已存证记录</div>
                </div>
                
                <div style="background: rgba(255, 152, 0, 0.1); border: 2px solid rgba(255, 152, 0, 0.3); border-radius: 15px; padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">👥</div>
                    <div style="font-size: 2rem; font-weight: 700; color: #ff9800; margin-bottom: 5px;" id="active-users">8,432</div>
                    <div style="font-size: 0.9rem; color: #ffcc02;">活跃用户</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let provider = null;
        let signer = null;
        let userAddress = null;
        
        // 通用钱包连接函数
        async function connectWalletGeneric(walletName, provider) {
            try {
                const accounts = await provider.request({ method: 'eth_requestAccounts' });
                window.provider = new ethers.providers.Web3Provider(provider);
                signer = window.provider.getSigner();
                userAddress = accounts[0];
                
                // 更新UI
                document.getElementById('wallet-status').classList.add('active');
                document.getElementById('wallet-status-text').textContent = `${walletName.toUpperCase()} CONNECTED`;
                document.getElementById('wallet-address').textContent = userAddress;
                document.getElementById('wallet-info').style.display = 'block';
                document.getElementById('store-data-btn').disabled = false;
                
                // 获取网络信息
                const network = await window.provider.getNetwork();
                document.getElementById('network-info').textContent = network.name || `Chain ID: ${network.chainId}`;
                
                // 获取余额
                const balance = await window.provider.getBalance(userAddress);
                document.getElementById('wallet-balance').textContent = `${ethers.utils.formatEther(balance).substring(0, 8)} ETH`;
                
                // 禁用所有钱包按钮
                const walletButtons = document.querySelectorAll('.wallet-button');
                walletButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                });
                
                console.log(`✅ ${walletName} 钱包连接成功`);
                
            } catch (error) {
                console.error(`连接${walletName}钱包失败:`, error);
                alert(`连接${walletName}钱包失败，请确保已安装对应钱包`);
            }
        }
        
        // MetaMask连接
        async function connectMetaMask() {
            if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
                await connectWalletGeneric('MetaMask', window.ethereum);
            } else {
                alert('请安装MetaMask钱包\
下载地址: https://metamask.io/');
            }
        }
        
        // WalletConnect连接
        async function connectWalletConnect() {
            try {
                // 检查是否有WalletConnect提供者
                if (typeof window.WalletConnect !== 'undefined') {
                    // 这里需要WalletConnect库的实际实现
                    alert('WalletConnect功能开发中\
请使用MetaMask或其他浏览器钱包');
                } else {
                    alert('WalletConnect功能开发中\
请使用MetaMask或其他浏览器钱包');
                }
            } catch (error) {
                console.error('WalletConnect连接失败:', error);
                alert('WalletConnect连接失败');
            }
        }
        
        // Coinbase Wallet连接
        async function connectCoinbase() {
            if (typeof window.ethereum !== 'undefined' && window.ethereum.isCoinbaseWallet) {
                await connectWalletGeneric('Coinbase', window.ethereum);
            } else if (typeof window.coinbaseWalletExtension !== 'undefined') {
                await connectWalletGeneric('Coinbase', window.coinbaseWalletExtension);
            } else {
                alert('请安装Coinbase Wallet\
下载地址: https://wallet.coinbase.com/');
            }
        }
        
        // Trust Wallet连接
        async function connectTrust() {
            if (typeof window.ethereum !== 'undefined' && window.ethereum.isTrust) {
                await connectWalletGeneric('Trust Wallet', window.ethereum);
            } else {
                alert('请安装Trust Wallet\
下载地址: https://trustwallet.com/');
            }
        }
        
        // Binance Chain Wallet连接
        async function connectBinance() {
            if (typeof window.BinanceChain !== 'undefined') {
                await connectWalletGeneric('Binance Wallet', window.BinanceChain);
            } else {
                alert('请安装Binance Chain Wallet\
下载地址: https://www.binance.org/en');
            }
        }
        
        // OKX Wallet连接
        async function connectOKX() {
            if (typeof window.okxwallet !== 'undefined') {
                await connectWalletGeneric('OKX Wallet', window.okxwallet);
            } else if (typeof window.ethereum !== 'undefined' && window.ethereum.isOkxWallet) {
                await connectWalletGeneric('OKX Wallet', window.ethereum);
            } else {
                alert('请安装OKX Wallet\
下载地址: https://www.okx.com/web3');
            }
        }
        
        // 存储数据到区块链（模拟）
        async function storeDataToBlockchain() {
            const title = document.getElementById('data-title').value;
            const type = document.getElementById('data-type').value;
            const content = document.getElementById('data-content').value;
            
            if (!title || !content) {
                alert('请填写完整的数据信息');
                return;
            }
            
            if (!signer) {
                alert('请先连接钱包');
                return;
            }
            
            try {
                // 模拟区块链交易
                const btn = document.getElementById('store-data-btn');
                const originalText = btn.querySelector('.button-text').textContent;
                btn.querySelector('.button-text').textContent = '⏳ 存储中...';
                btn.disabled = true;
                
                // 模拟交易延迟
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // 清空表单
                document.getElementById('data-title').value = '';
                document.getElementById('data-content').value = '';
                
                // 更新UI
                btn.querySelector('.button-text').textContent = originalText;
                btn.disabled = false;
                
                alert('数据已成功存储到区块链！\n交易哈希: 0x' + Math.random().toString(16).substr(2, 64));
                
            } catch (error) {
                console.error('存储失败:', error);
                alert('存储失败，请重试');
                
                const btn = document.getElementById('store-data-btn');
                btn.querySelector('.button-text').textContent = '🔐 存储到区块链';
                btn.disabled = false;
            }
        }
        
        // 更新区块链统计数据
        function updateBlockchainStats() {
            // 模拟实时数据更新
            const baseHeight = 18547293;
            const currentHeight = baseHeight + Math.floor(Math.random() * 100);
            document.getElementById('block-height').textContent = currentHeight.toLocaleString();
            
            const gasPrice = 20 + Math.floor(Math.random() * 20);
            document.getElementById('gas-price').textContent = gasPrice;
            
            const totalTxn = 47293 + Math.floor(Math.random() * 1000);
            document.getElementById('total-transactions').textContent = totalTxn.toLocaleString();
            
            const storedRecords = 1247 + Math.floor(Math.random() * 100);
            document.getElementById('stored-records').textContent = storedRecords.toLocaleString();
            
            const activeUsers = 8432 + Math.floor(Math.random() * 500);
            document.getElementById('active-users').textContent = activeUsers.toLocaleString();
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 绑定存储按钮
            document.getElementById('store-data-btn').addEventListener('click', storeDataToBlockchain);
            
            // 启动统计数据更新
            updateBlockchainStats();
            setInterval(updateBlockchainStats, 5000);
            
            // 检测已安装的钱包
            detectInstalledWallets();
        });
        
        // 检测已安装的钱包
        function detectInstalledWallets() {
            const walletStatus = {
                metamask: typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask,
                coinbase: typeof window.ethereum !== 'undefined' && window.ethereum.isCoinbaseWallet,
                trust: typeof window.ethereum !== 'undefined' && window.ethereum.isTrust,
                binance: typeof window.BinanceChain !== 'undefined',
                okx: typeof window.okxwallet !== 'undefined' || (typeof window.ethereum !== 'undefined' && window.ethereum.isOkxWallet)
            };
            
            console.log('检测到的钱包:', walletStatus);
        }
    </script>
</body>
</html>