<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3Dè™šæ‹ŸåŸå¸‚ - Solarpunk Smart City</title>
    <link rel="stylesheet" href="../components/ui.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/FXAAShader.js"></script>
    <script src="../js/advanced-city-renderer.js"></script>
</head>
<body>
    <!-- é«˜ç§‘æŠ€èƒŒæ™¯ -->
    <div class="tech-background">
        <div class="grid-overlay"></div>
        <div class="floating-particles"></div>
        <div class="scan-lines"></div>
    </div>
    
    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 0 40px;">
        <div class="back-button-container">
            <a href="./index.html" class="back-button">â† è¿”å›ä¸»é¡µ</a>
        </div>
        
        <!-- é¡µé¢æ ‡é¢˜åŒºåŸŸ -->
        <div class="page-header" style="text-align: center; margin-bottom: 60px;">
            <div class="tech-badge">
                <div class="badge-glow"></div>
                <span class="badge-text">ğŸ™ï¸ 3D CITY VISUALIZATION MODULE</span>
            </div>
            <h1 style="margin: 30px 0 20px;">3Dè™šæ‹ŸåŸå¸‚</h1>
            <p style="font-size: 1.3rem; color: rgba(255, 255, 255, 0.8); max-width: 800px; margin: 0 auto;">
                æ²‰æµ¸å¼å¤ªé˜³èƒ½æœ‹å…‹åŸå¸‚ä¸‰ç»´å»ºæ¨¡ä¸å®æ—¶æ¸²æŸ“ç³»ç»Ÿ
            </p>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ - å·¦å³å¸ƒå±€ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px;">
        
        <!-- å·¦ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
        <div class="tech-module city-module">
            <div class="module-header">
                <div class="module-status-bar">
                    <div class="status-indicator active"></div>
                    <span class="status-text">PARAMETERS CONFIG</span>
                </div>
                <div class="module-id">CTRL_PANEL</div>
            </div>
            
            <div class="module-icon-container">
                <div class="icon-background city-bg"></div>
                <div class="module-icon">âš™ï¸</div>
                <div class="icon-pulse city-pulse"></div>
            </div>
            
            <div class="module-info">
                <h3 class="module-name">åŸå¸‚ç”Ÿæˆå‚æ•°é…ç½®</h3>
                <p class="module-description">è°ƒæ•´å‚æ•°å®æ—¶ç”Ÿæˆä¸åŒé£æ ¼çš„å¤ªé˜³èƒ½æœ‹å…‹åŸå¸‚</p>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin: 30px 0;">
                <div style="background: rgba(76, 175, 80, 0.1); border: 2px solid rgba(76, 175, 80, 0.3); border-radius: 15px; padding: 25px;">
                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #4caf50; font-size: 1rem; letter-spacing: 1px;">
                        ğŸ² éšæœºç§å­
                    </label>
                    <input id="seed" type="number" value="42" style="width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid rgba(76, 175, 80, 0.4); border-radius: 10px; background: rgba(76, 175, 80, 0.05); color: white;">
                    <small style="color: #81c784; font-size: 0.9rem; margin-top: 8px; display: block;">
                        ç›¸åŒç§å­ç”Ÿæˆç›¸åŒåŸå¸‚å¸ƒå±€
                    </small>
                </div>
                
                <div style="background: rgba(76, 175, 80, 0.1); border: 2px solid rgba(76, 175, 80, 0.3); border-radius: 15px; padding: 25px;">
                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #4caf50; font-size: 1rem; letter-spacing: 1px;">
                        ğŸ—ï¸ åŸå¸‚ç½‘æ ¼
                    </label>
                    <input id="grid" type="number" value="6" min="2" max="12" style="width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid rgba(76, 175, 80, 0.4); border-radius: 10px; background: rgba(76, 175, 80, 0.05); color: white;">
                    <small style="color: #81c784; font-size: 0.9rem; margin-top: 8px; display: block;">
                        æ•°å€¼è¶Šå¤§åŸå¸‚è¶Šå¯†é›†
                    </small>
                </div>
                
                <div style="background: rgba(76, 175, 80, 0.1); border: 2px solid rgba(76, 175, 80, 0.3); border-radius: 15px; padding: 25px;">
                    <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #4caf50; font-size: 1rem; letter-spacing: 1px;">
                        ğŸ¢ æœ€å¤§é«˜åº¦
                    </label>
                    <input id="maxH" type="number" value="16" min="4" max="50" style="width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid rgba(76, 175, 80, 0.4); border-radius: 10px; background: rgba(76, 175, 80, 0.05); color: white;">
                    <small style="color: #81c784; font-size: 0.9rem; margin-top: 8px; display: block;">
                        æ§åˆ¶å¤©é™…çº¿é«˜åº¦
                    </small>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button id="genBtn" class="tech-button city-button" style="width: auto; padding: 18px 40px; font-size: 1.2rem; min-width: 280px;">
                    <span class="button-text">ğŸš€ é‡æ–°ç”ŸæˆåŸå¸‚</span>
                    <div class="button-arrow">â†’</div>
                    <div class="button-glow"></div>
                </button>
            </div>
        </div>

        <!-- å³ä¾§ï¼š3Dè§†çª— -->
        <div class="tech-module city-module">
            <div class="module-header">
                <div class="module-status-bar">
                    <div class="status-indicator active"></div>
                    <span class="status-text">3D ENGINE ACTIVE</span>
                </div>
                <div class="module-id">VIEWPORT</div>
            </div>
            
            <div class="module-icon-container">
                <div class="icon-background city-bg"></div>
                <div class="module-icon">ğŸŒ†</div>
                <div class="icon-pulse city-pulse"></div>
            </div>
            
            <div class="module-info">
                <h3 class="module-name">3DåŸå¸‚å®æ—¶é¢„è§ˆ</h3>
                <p class="module-description">Three.jsé©±åŠ¨çš„æ²‰æµ¸å¼åŸå¸‚å¯è§†åŒ–ä½“éªŒ</p>
            </div>
            
            <div id="viewport" style="height: 70vh; border-radius: 15px; overflow: hidden; 
                 background: linear-gradient(135deg, #0a0e27 0%, #1a237e 50%, #000051 100%); 
                 border: 3px solid rgba(76, 175, 80, 0.4); position: relative; margin: 30px 0;
                 box-shadow: 0 15px 40px rgba(76, 175, 80, 0.2), inset 0 0 30px rgba(0, 229, 255, 0.1);">
                
                <!-- åŠ è½½æç¤º -->
                <div id="loading-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                     background: rgba(10, 14, 39, 0.95); display: flex; align-items: center; justify-content: center; 
                     z-index: 10; backdrop-filter: blur(10px);">
                    <div style="text-align: center; color: #4caf50;">
                        <div style="width: 60px; height: 60px; border: 4px solid rgba(76, 175, 80, 0.3); 
                             border-top: 4px solid #4caf50; border-radius: 50%; animation: spin 1s linear infinite; 
                             margin: 0 auto 20px;"></div>
                        <p style="font-size: 1.4rem; font-weight: 700; margin-bottom: 10px;">ğŸŒ± æ­£åœ¨ç”Ÿæˆå¤ªé˜³èƒ½æœ‹å…‹åŸå¸‚</p>
                        <p style="font-size: 1rem; color: #81c784;">Three.js 3Då¼•æ“å¯åŠ¨ä¸­...</p>
                    </div>
                </div>
            </div>
            
            <!-- æŠ€æœ¯è§„æ ¼ -->
            <div class="tech-specs">
                <div class="spec-item">
                    <span class="spec-label">ENGINE</span>
                    <span class="spec-value">Three.js</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">FPS</span>
                    <span class="spec-value">60</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">MODELS</span>
                    <span class="spec-value" id="model-count">0</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">TRIANGLES</span>
                    <span class="spec-value" id="triangle-count">0</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">QUALITY</span>
                    <span class="spec-value" id="quality-level">AUTO</span>
                </div>
            </div>
            
            <!-- æ§åˆ¶è¯´æ˜ -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-top: 30px;">
                <div style="background: rgba(76, 175, 80, 0.1); border: 2px solid rgba(76, 175, 80, 0.3); border-radius: 15px; padding: 25px;">
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <div style="font-size: 2.5rem; margin-right: 15px;">ğŸ–±ï¸</div>
                        <strong style="font-size: 1.3rem; color: #4caf50; letter-spacing: 1px;">äº¤äº’æ§åˆ¶</strong>
                    </div>
                    <div style="line-height: 1.8; color: #81c784;">
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #4caf50;">
                            â€¢ é¼ æ ‡æ‹–æ‹½ï¼š360Â°æ—‹è½¬è§†è§’
                        </div>
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #4caf50;">
                            â€¢ æ»šè½®ç¼©æ”¾ï¼šè¿œè¿‘è§†å›¾åˆ‡æ¢
                        </div>
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 12px 16px; border-radius: 8px; border-left: 3px solid #4caf50;">
                            â€¢ è‡ªåŠ¨æ—‹è½¬ï¼šæ²‰æµ¸å¼ä½“éªŒ
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(76, 175, 80, 0.1); border: 2px solid rgba(76, 175, 80, 0.3); border-radius: 15px; padding: 25px;">
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <div style="font-size: 2.5rem; margin-right: 15px;">ğŸŒ±</div>
                        <strong style="font-size: 1.3rem; color: #4caf50; letter-spacing: 1px;">å¯æŒç»­å…ƒç´ </strong>
                    </div>
                    <div style="line-height: 1.8; color: #81c784;">
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #4caf50;">
                            â€¢ ç»¿è‰²å±‹é¡¶èŠ±å›­ç³»ç»Ÿ
                        </div>
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #4caf50;">
                            â€¢ å¤ªé˜³èƒ½ç”µæ± æ¿é˜µåˆ—
                        </div>
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #4caf50;">
                            â€¢ å¾®å‹é£åŠ›å‘ç”µæœº
                        </div>
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 12px 16px; border-radius: 8px; border-left: 3px solid #4caf50;">
                            â€¢ å‚ç›´ç»¿åŒ–ç«‹ä½“ç³»ç»Ÿ
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        </div> <!-- ç»“æŸå·¦å³å¸ƒå±€å®¹å™¨ -->
    </div>

    <script>
        // é«˜æ€§èƒ½åŸå¸‚æ¸²æŸ“å™¨å®ä¾‹
        let cityRenderer = null;
        let statsUpdateInterval = null;
        
        // åˆå§‹åŒ–é«˜çº§æ¸²æŸ“å¼•æ“
        function initAdvancedRenderer() {
            const viewport = document.getElementById('viewport');
            cityRenderer = new AdvancedCityRenderer(viewport);
            
            // æ˜¾ç¤ºæ€§èƒ½ç­‰çº§
            document.getElementById('quality-level').textContent = cityRenderer.performanceLevel.toUpperCase();
            
            // ç”Ÿæˆåˆå§‹åŸå¸‚
            generateAdvancedCity();
            
            // å¯åŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
            startStatsUpdate();
            
            console.log('ğŸš€ Advanced City Renderer initialized successfully!');
        }
        
        // ç”Ÿæˆé«˜çº§åŸå¸‚
        function generateAdvancedCity() {
            if (!cityRenderer) return;
            
            const params = {
                seed: parseInt(document.getElementById('seed').value) || 42,
                gridSize: parseInt(document.getElementById('grid').value) || 6,
                maxHeight: parseInt(document.getElementById('maxH').value) || 16,
                density: 0.7
            };
            
            cityRenderer.generateCity(params);
            updateDisplayStats();
        }
        
        // æ›´æ–°æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        function updateDisplayStats() {
            if (!cityRenderer) return;
            
            const stats = cityRenderer.getStats();
            document.getElementById('model-count').textContent = stats.geometries.toLocaleString();
            if (document.getElementById('triangle-count')) {
                document.getElementById('triangle-count').textContent = Math.round(stats.triangles / 1000) + 'K';
            }
        }
        
        // å¯åŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
        function startStatsUpdate() {
            if (statsUpdateInterval) clearInterval(statsUpdateInterval);
            
            statsUpdateInterval = setInterval(() => {
                if (cityRenderer) {
                    const stats = cityRenderer.getStats();
                    // æ›´æ–°FPSæ˜¾ç¤ºï¼ˆå¦‚æœéœ€è¦ï¼‰
                    const fpsElements = document.querySelectorAll('.spec-value');
                    if (fpsElements[1]) {
                        fpsElements[1].textContent = stats.fps || 60;
                    }
                }
            }, 1000);
        }
        
        // å¯¼å‡ºåŸå¸‚æ•°æ®
        function exportCityData() {
            if (!cityRenderer) return;
            
            const stats = cityRenderer.getStats();
            const data = {
                timestamp: new Date().toISOString(),
                performance: cityRenderer.performanceLevel,
                stats: stats,
                settings: cityRenderer.qualitySettings
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'solarpunk-city-data.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // åˆ‡æ¢è‡ªåŠ¨æ—‹è½¬
        function toggleAutoRotate() {
            if (cityRenderer) {
                const currentState = cityRenderer.controls.autoRotate;
                cityRenderer.setAutoRotate(!currentState);
            }
        }
        
        // é‡ç½®ç›¸æœºè§†è§’
        function resetCamera() {
            if (cityRenderer) {
                cityRenderer.setCameraPosition(40, 25, 40);
            }
        }
        

        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å»¶è¿Ÿåˆå§‹åŒ–ä»¥æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            setTimeout(() => {
                try {
                    initAdvancedRenderer();
                
                // éšè—åŠ è½½æç¤º
                setTimeout(() => {
                    const loadingOverlay = document.getElementById('loading-overlay');
                    if (loadingOverlay) {
                        loadingOverlay.style.opacity = '0';
                        loadingOverlay.style.transition = 'opacity 0.5s ease';
                        setTimeout(() => {
                            loadingOverlay.style.display = 'none';
                        }, 500);
                    }
                }, 1000);
                } catch (error) {
                    console.error('Failed to initialize Advanced City Renderer:', error);
                    
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    const loadingOverlay = document.getElementById('loading-overlay');
                    if (loadingOverlay) {
                        loadingOverlay.innerHTML = `
                            <div style="text-align: center; color: #f44336;">
                                <div style="font-size: 2rem; margin-bottom: 10px;">âš ï¸</div>
                                <div style="font-size: 1.1rem;">æ¸²æŸ“å¼•æ“åˆå§‹åŒ–å¤±è´¥</div>
                                <div style="font-size: 0.9rem; margin-top: 10px; opacity: 0.8;">è¯·æ£€æŸ¥æµè§ˆå™¨WebGLæ”¯æŒ</div>
                            </div>
                        `;
                    }
                }
            }, 1500);
            
            // ç»‘å®šç”ŸæˆæŒ‰é’®
            document.getElementById('genBtn').addEventListener('click', () => {
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'flex';
                    loadingOverlay.style.opacity = '1';
                }
                
                setTimeout(() => {
                    generateAdvancedCity();
                    setTimeout(() => {
                        if (loadingOverlay) {
                            loadingOverlay.style.opacity = '0';
                            setTimeout(() => {
                                loadingOverlay.style.display = 'none';
                            }, 500);
                        }
                    }, 800);
                }, 200);
            });
            
            // å‚æ•°å˜åŒ–æ—¶è‡ªåŠ¨é‡æ–°ç”Ÿæˆ
            ['seed', 'grid', 'maxH'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    setTimeout(generateAdvancedCity, 100);
                });
            });
        });
        
        // æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            if (cityRenderer) {
                cityRenderer.dispose();
            }
            if (statsUpdateInterval) {
                clearInterval(statsUpdateInterval);
            }
        });
    </script>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å·¦å³å¸ƒå±€å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            div[style*="display: grid; grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
                gap: 30px !important;
            }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            #viewport {
                height: 50vh;
            }
            
            div[style*="display: grid; grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }
        }
    </style>
</body>
</html>